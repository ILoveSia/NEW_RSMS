/**
 * ÏûÑÏõêÏ†ïÎ≥¥ Îì±Î°ù/ÏàòÏ†ï/ÏÉÅÏÑ∏ Î™®Îã¨ Ïª¥Ìè¨ÎÑåÌä∏
 * @description PositionFormModal ÌëúÏ§Ä Íµ¨Ï°∞Î•º Ï†ÅÏö©Ìïú ÏûÑÏõêÏ†ïÎ≥¥ Ìèº Î™®Îã¨
 */

import React, { useCallback, useEffect, useMemo, useState } from 'react';
import {
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  IconButton,
  Typography,
  TextField,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  FormControlLabel,
  RadioGroup,
  Radio,
  Chip,
  Divider,
  Box
} from '@mui/material';
import CloseIcon from '@mui/icons-material/Close';
import PersonIcon from '@mui/icons-material/Person';
import BusinessIcon from '@mui/icons-material/Business';
import AssignmentIcon from '@mui/icons-material/Assignment';
import WorkIcon from '@mui/icons-material/Work';
import GavelIcon from '@mui/icons-material/Gavel';
import { useForm, Controller, useFieldArray } from 'react-hook-form';
import { yupResolver } from '@hookform/resolvers/yup';
import * as yup from 'yup';

// Shared Components
import { Button } from '@/shared/components/atoms/Button';
import { BaseDataGrid } from '@/shared/components/organisms/BaseDataGrid';

// Types and validation
import type {
  OfficerInfo,
  OfficerInfoFormData,
  MeetingBodyFormData,
  ResponsibilityFormData,
  ManagementObligationFormData
} from '../../types/officerInfo.types';

import {
  OFFICER_INFO_BUSINESS_RULES,
  DUAL_POSITION_OPTIONS,
  MEETING_FREQUENCY_OPTIONS,
  MODAL_MODES
} from '../../types/officerInfo.types';

// Column definitions
import {
  meetingBodyColumns,
  responsibilityColumns,
  managementObligationColumns
} from '../OfficerInfoDataGrid/officerInfoColumns';

import styles from './OfficerInfoFormModal.module.scss';

// üéØ Validation Schema
const validationSchema = yup.object({
  positionCode: yup.string().required('ÏßÅÏ±ÖÏùÄ ÌïÑÏàòÏûÖÎãàÎã§'),
  officerName: yup
    .string()
    .required('ÏûÑÏõêÎ™ÖÏùÄ ÌïÑÏàòÏûÖÎãàÎã§')
    .max(OFFICER_INFO_BUSINESS_RULES.MAX_OFFICER_NAME_LENGTH, `ÏûÑÏõêÎ™ÖÏùÄ ${OFFICER_INFO_BUSINESS_RULES.MAX_OFFICER_NAME_LENGTH}Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî`),
  officerPosition: yup
    .string()
    .max(OFFICER_INFO_BUSINESS_RULES.MAX_POSITION_LENGTH, `ÏßÅÏúÑÎäî ${OFFICER_INFO_BUSINESS_RULES.MAX_POSITION_LENGTH}Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî`),
  isDualPosition: yup.boolean().required('Í≤∏ÏßÅÏó¨Î∂ÄÎäî ÌïÑÏàòÏûÖÎãàÎã§'),
  dualPositionDetails: yup.string().when('isDualPosition', {
    is: true,
    then: (schema) => schema
      .required('Í≤∏ÏßÅÏó¨Î∂ÄÍ∞Ä YÏù∏ Í≤ΩÏö∞ Í≤∏ÏßÅÏÇ¨Ìï≠ÏùÄ ÌïÑÏàòÏûÖÎãàÎã§')
      .max(OFFICER_INFO_BUSINESS_RULES.MAX_DUAL_POSITION_DETAILS_LENGTH, `Í≤∏ÏßÅÏÇ¨Ìï≠ÏùÄ ${OFFICER_INFO_BUSINESS_RULES.MAX_DUAL_POSITION_DETAILS_LENGTH}Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî`),
    otherwise: (schema) => schema.max(OFFICER_INFO_BUSINESS_RULES.MAX_DUAL_POSITION_DETAILS_LENGTH, `Í≤∏ÏßÅÏÇ¨Ìï≠ÏùÄ ${OFFICER_INFO_BUSINESS_RULES.MAX_DUAL_POSITION_DETAILS_LENGTH}Ïûê Ïù¥ÌïòÎ°ú ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî`)
  }),
  responsibilityAssignDate: yup
    .string()
    .required('Ï±ÖÎ¨¥Ï†ïÎ≥¥ Î∂ÄÏó¨ÏùºÏûêÎäî ÌïÑÏàòÏûÖÎãàÎã§'),
  meetingBodies: yup
    .array()
    .min(OFFICER_INFO_BUSINESS_RULES.MIN_MEETING_BODIES, `ÏµúÏÜå ${OFFICER_INFO_BUSINESS_RULES.MIN_MEETING_BODIES}Í∞úÏùò ÌöåÏùòÏ≤¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§`),
  responsibilities: yup
    .array()
    .min(OFFICER_INFO_BUSINESS_RULES.MIN_RESPONSIBILITIES, `ÏµúÏÜå ${OFFICER_INFO_BUSINESS_RULES.MIN_RESPONSIBILITIES}Í∞úÏùò Ï±ÖÎ¨¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§`),
  managementObligations: yup
    .array()
    .min(OFFICER_INFO_BUSINESS_RULES.MIN_MANAGEMENT_OBLIGATIONS, `ÏµúÏÜå ${OFFICER_INFO_BUSINESS_RULES.MIN_MANAGEMENT_OBLIGATIONS}Í∞úÏùò Í¥ÄÎ¶¨ÏùòÎ¨¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§`)
});

interface OfficerInfoFormModalProps {
  open: boolean;
  mode: 'create' | 'edit' | 'view';
  officerInfo?: OfficerInfo;
  onClose: () => void;
  onSubmit: (data: OfficerInfoFormData) => Promise<void>;
  loading?: boolean;
}

const OfficerInfoFormModal: React.FC<OfficerInfoFormModalProps> = ({
  open,
  mode,
  officerInfo,
  onClose,
  onSubmit,
  loading = false
}) => {
  // üìù Form Management
  const {
    control,
    handleSubmit,
    setValue,
    watch,
    formState: { errors, isValid }
  } = useForm<OfficerInfoFormData>({
    resolver: yupResolver(validationSchema),
    defaultValues: {
      positionCode: '',
      officerName: '',
      officerPosition: '',
      isDualPosition: false,
      dualPositionDetails: '',
      responsibilityAssignDate: '',
      meetingBodies: [],
      responsibilityOverview: '',
      responsibilities: [],
      managementObligations: [],
      workNotes: '',
      verifierPosition: '',
      verifierName: ''
    }
  });

  // üìã Field Arrays
  const { fields: meetingBodyFields, append: appendMeetingBody, remove: removeMeetingBody } = useFieldArray({
    control,
    name: 'meetingBodies'
  });

  const { fields: responsibilityFields, append: appendResponsibility, remove: removeResponsibility } = useFieldArray({
    control,
    name: 'responsibilities'
  });

  const { fields: obligationFields, append: appendObligation, remove: removeObligation } = useFieldArray({
    control,
    name: 'managementObligations'
  });

  // üëÄ Watch values
  const isDualPosition = watch('isDualPosition');

  // üéØ Modal Configuration
  const modalConfig = MODAL_MODES[mode];
  const isReadonly = modalConfig.readonly;

  // üìä Mock Îç∞Ïù¥ÌÑ∞
  const mockPositions = [
    { code: 'POS001', name: 'ÏµúÍ≥†Í≤ΩÏòÅÏßÑ' },
    { code: 'POS002', name: 'Ïò§ÌÜ†Í∏àÏúµÎ≥∏Î∂ÄÏû•' },
    { code: 'POS003', name: 'Î¶¨Ïä§ÌÅ¨Í¥ÄÎ¶¨Î≥∏Î∂ÄÏû•' },
    { code: 'POS004', name: 'ÏòÅÏóÖÎ≥∏Î∂ÄÏû•' }
  ];

  // üéØ Form Ï¥àÍ∏∞Ìôî
  useEffect(() => {
    if (officerInfo && mode !== 'create') {
      setValue('positionCode', officerInfo.positionCode);
      setValue('officerName', officerInfo.officerName || '');
      setValue('officerPosition', officerInfo.officerPosition || '');
      setValue('isDualPosition', officerInfo.isDualPosition);
      setValue('dualPositionDetails', officerInfo.dualPositionDetails || '');
      setValue('responsibilityAssignDate', officerInfo.responsibilityAssignDate || '');

      // Mock Îç∞Ïù¥ÌÑ∞Î°ú Ï¥àÍ∏∞Ìôî
      if (officerInfo.meetingBodies && officerInfo.meetingBodies.length > 0) {
        setValue('meetingBodies', officerInfo.meetingBodies.map(mb => ({
          meetingName: mb.meetingName,
          chairperson: mb.chairperson,
          frequency: mb.frequency,
          mainAgenda: mb.mainAgenda,
          seq: mb.seq
        })));
      } else {
        // Default meeting bodies
        setValue('meetingBodies', [
          {
            meetingName: 'ÎÇ¥Î∂ÄÌÜµÏ†úÏúÑÏõêÌöå',
            chairperson: 'ÏúÑÏõê',
            frequency: 'Ïõî 1Ìöå',
            mainAgenda: 'Ï†ïÍ∏∞Î™®ÎãàÌÑ∞ÎßÅ Ï≤¥ÌÅ¨',
            seq: 1
          },
          {
            meetingName: 'ÎÇ¥Î∂ÄÌÜµÏ†úÏúÑÏõêÌöå',
            chairperson: 'ÏúÑÏõê',
            frequency: 'Ïõî 1Ìöå',
            mainAgenda: 'Ï†ïÍ∏∞Î™®ÎãàÌÑ∞ÎßÅ Ï≤¥ÌÅ¨',
            seq: 2
          }
        ]);
      }

      // Default responsibilities
      setValue('responsibilities', [
        {
          responsibility: '(Í≥µÌÜµ) ÏÜåÍ¥Ä ÏóÖÎ¨¥Ï°∞ÏßÅ ÎÇ¥ Î≤ïÎ†πÏúÑÎ∞ò Î∞è ÏúÑÌóòÏÉÅÌô©Ïóê ÎåÄÌïú Ï±ÖÎ¨¥',
          responsibilityDetails: 'ÏòÅÏóÖÍ¥ÄÎ†® ÎÇ¥Î∂ÄÌÜµÏ†ú ÎåÄÌïú Ï±ÖÎ¨¥ ÏÑ∏Î∂ÄÎÇ¥Ïö©',
          legalBasis: 'ÏòÅÏóÖÍ¥ÄÎ†® ÎÇ¥Î∂ÄÌÜµÏ†ú Í∞ïÌôîÎ•º ÏúÑÌïú ÎÇ¥Í∑ú Ï†ú003',
          seq: 1
        },
        {
          responsibility: 'Ï†ïÏòÅÍ¥ÄÎ†® ÏÜêÏùµÍ≥º Í¥ÄÎ†®Îêú Ï±ÖÎ¨¥',
          responsibilityDetails: 'Ï†ïÏòÅÍ¥ÄÎ†® ÏÜêÏùµ Í¥ÄÎ†® Ï±ÖÎ¨¥ ÏÑ∏Î∂ÄÎÇ¥Ïö©',
          legalBasis: 'Ï†ïÏòÅÍ¥ÄÎ†® ÏÜêÏùµ ÎÇ¥Í∑ú Ï†ú003',
          seq: 2
        }
      ]);

      // Default management obligations
      setValue('managementObligations', [
        {
          obligationContent: '1) ÏòÅÏóÖÍ¥ÄÎ†® ÏÜêÏùµ Í¥ÄÎ¶¨ÏùòÎ¨¥ ÏÑ∏Î∂ÄÎÇ¥Ïö©',
          legalBasis: '1) ÏòÅÏóÖÍ¥ÄÎ†® ÏÜêÏùµ Í¥ÄÎ¶¨ÏùòÎ¨¥ ÏÑ∏Î∂ÄÎÇ¥Ïö© 2) ÏòÅÏóÖÍ¥ÄÎ†® ÏÜêÏùµ Í¥ÄÎ¶¨ÏùòÎ¨¥ ÏÑ∏Î∂ÄÎÇ¥Ïö© 3) ÏòÅÏóÖÍ¥ÄÎ†® ÎÇ¥Î∂ÄÌÜµÏ†ú ÎåÄÌïú Í¥ÄÎ¶¨ÏùòÎ¨¥',
          seq: 1
        },
        {
          obligationContent: '2) ÏòÅÏóÖÍ¥ÄÎ†® ÏÜêÏùµ Í¥ÄÎ¶¨ÏùòÎ¨¥ ÏÑ∏Î∂ÄÎÇ¥Ïö© 2',
          legalBasis: '2) ÏòÅÏóÖÍ¥ÄÎ†® ÏÜêÏùµ ÎÇ¥Í∑ú Ï†ú003',
          seq: 2
        },
        {
          obligationContent: '3) ÏòÅÏóÖÍ¥ÄÎ†® ÎÇ¥Î∂ÄÌÜµÏ†ú ÎåÄÌïú Í¥ÄÎ¶¨ÏùòÎ¨¥',
          legalBasis: '3) ÏòÅÏóÖÍ¥ÄÎ†® ÎÇ¥Î∂ÄÌÜµÏ†ú Í∞ïÌôîÎ•º ÏúÑÌïú ÎÇ¥Í∑ú Ï†ú003',
          seq: 3
        }
      ]);

      setValue('responsibilityOverview', 'Ïò§ÌÜ†Í∏àÏúµ Î∂ÑÏïº Í∏àÏúµÏòÅÏóÖ Í¥ÄÎ†® Ï±ÖÎ¨¥');
      setValue('workNotes', 'Ï¥àÏßÅÎåÄÎ≤ïÏóêÏÑú Ï†ïÌïú ÏûëÏóÖÏúÑÌóòÏÑ± Í¥ÄÎ†® Ï±ÖÎ¨¥ÏóêÏÑú');
      setValue('verifierPosition', '2025-08-01');
    }
  }, [officerInfo, mode, setValue]);

  // üéØ Event Handlers
  const handleFormSubmit = useCallback(async (data: OfficerInfoFormData) => {
    try {
      await onSubmit(data);
    } catch (error) {
      console.error('Submit error:', error);
    }
  }, [onSubmit]);

  const handleAddMeetingBody = useCallback(() => {
    appendMeetingBody({
      meetingName: '',
      chairperson: '',
      frequency: 'Ïõî 1Ìöå',
      mainAgenda: '',
      seq: meetingBodyFields.length + 1
    });
  }, [appendMeetingBody, meetingBodyFields.length]);

  const handleAddResponsibility = useCallback(() => {
    appendResponsibility({
      responsibility: '',
      responsibilityDetails: '',
      legalBasis: '',
      seq: responsibilityFields.length + 1
    });
  }, [appendResponsibility, responsibilityFields.length]);

  const handleAddObligation = useCallback(() => {
    appendObligation({
      obligationContent: '',
      legalBasis: '',
      seq: obligationFields.length + 1
    });
  }, [appendObligation, obligationFields.length]);

  return (
    <Dialog
      open={open}
      onClose={onClose}
      maxWidth="lg"
      fullWidth
      className={styles.modal}
    >
      <DialogTitle className={styles.modalTitle}>
        <div className={styles.titleContent}>
          <PersonIcon className={styles.titleIcon} />
          <Typography variant="h6" component="div">
            {modalConfig.title}
          </Typography>
        </div>
        <IconButton
          aria-label="close"
          onClick={onClose}
          className={styles.closeButton}
        >
          <CloseIcon />
        </IconButton>
      </DialogTitle>

      <DialogContent className={styles.modalContent}>
        <form onSubmit={handleSubmit(handleFormSubmit)} className={styles.form}>
          {/* üìã Section 1: ÏûÑÏõê Î∞è ÏßÅÏ±Ö Ï†ïÎ≥¥ */}
          <div className={styles.formSection}>
            <div className={styles.sectionHeader}>
              <Typography variant="h6" className={styles.sectionTitle}>
                <PersonIcon />
                ÏûÑÏõê Î∞è ÏßÅÏ±Ö Ï†ïÎ≥¥
              </Typography>
            </div>

            <div className={styles.formRow}>
              <div className={styles.formGroup}>
                <Controller
                  name="positionCode"
                  control={control}
                  render={({ field }) => (
                    <FormControl fullWidth error={!!errors.positionCode} disabled={isReadonly}>
                      <InputLabel>ÏßÅÏ±Ö *</InputLabel>
                      <Select {...field} label="ÏßÅÏ±Ö *">
                        {mockPositions.map((position) => (
                          <MenuItem key={position.code} value={position.code}>
                            {position.name}
                          </MenuItem>
                        ))}
                      </Select>
                      {errors.positionCode && (
                        <Typography variant="caption" color="error">
                          {errors.positionCode.message}
                        </Typography>
                      )}
                    </FormControl>
                  )}
                />
              </div>
              <div className={styles.formGroup}>
                <Controller
                  name="officerName"
                  control={control}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      label="ÏÑ±Î™Ö *"
                      fullWidth
                      error={!!errors.officerName}
                      helperText={errors.officerName?.message}
                      disabled={isReadonly}
                    />
                  )}
                />
              </div>
            </div>

            <div className={styles.formRow}>
              <div className={styles.formGroup}>
                <Controller
                  name="isDualPosition"
                  control={control}
                  render={({ field }) => (
                    <FormControl disabled={isReadonly}>
                      <Typography variant="body2" gutterBottom>
                        Í≤∏ÏßÅÏó¨Î∂Ä *
                      </Typography>
                      <RadioGroup
                        {...field}
                        row
                        value={field.value}
                        onChange={(e) => field.onChange(e.target.value === 'true')}
                      >
                        <FormControlLabel value={true} control={<Radio />} label="Y" />
                        <FormControlLabel value={false} control={<Radio />} label="N" />
                      </RadioGroup>
                    </FormControl>
                  )}
                />
              </div>
              <div className={styles.formGroup}>
                <Controller
                  name="responsibilityAssignDate"
                  control={control}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      label="Ï±ÖÎ¨¥Ï†ïÎ≥¥ Î∂ÄÏó¨ÏùºÏûê *"
                      type="date"
                      fullWidth
                      InputLabelProps={{ shrink: true }}
                      error={!!errors.responsibilityAssignDate}
                      helperText={errors.responsibilityAssignDate?.message}
                      disabled={isReadonly}
                    />
                  )}
                />
              </div>
            </div>

            {isDualPosition && (
              <div className={styles.formRow}>
                <div className={styles.formGroup}>
                  <Controller
                    name="dualPositionDetails"
                    control={control}
                    render={({ field }) => (
                      <TextField
                        {...field}
                        label="Í≤∏ÏßÅÏÇ¨Ìï≠"
                        multiline
                        rows={3}
                        fullWidth
                        error={!!errors.dualPositionDetails}
                        helperText={errors.dualPositionDetails?.message}
                        disabled={isReadonly}
                      />
                    )}
                  />
                </div>
              </div>
            )}
          </div>

          <Divider className={styles.divider} />

          {/* üìã Section 2: ÏÜåÍ¥ÄÎ∂ÄÏ†ê ÌöåÏùòÏ≤¥ Ï†ïÎ≥¥ */}
          <div className={styles.formSection}>
            <div className={styles.sectionHeader}>
              <Typography variant="h6" className={styles.sectionTitle}>
                <BusinessIcon />
                ÏÜåÍ¥ÄÎ∂ÄÏ†ê Ï†ïÎ≥¥
              </Typography>
              {!isReadonly && (
                <Button
                  variant="outlined"
                  size="small"
                  onClick={handleAddMeetingBody}
                >
                  ÌöåÏùòÏ≤¥ Ï∂îÍ∞Ä
                </Button>
              )}
            </div>

            <div className={styles.tableContainer}>
              <BaseDataGrid
                data={meetingBodyFields}
                columns={meetingBodyColumns}
                height={200}
                pagination={false}
                theme="alpine"
              />
            </div>
          </div>

          <Divider className={styles.divider} />

          {/* üìã Section 3: ÏûëÏóÖÎÇ¥Ïó≠ */}
          <div className={styles.formSection}>
            <Typography variant="h6" className={styles.sectionTitle}>
              <WorkIcon />
              ÏûëÏóÖÎÇ¥Ïó≠
            </Typography>

            <div className={styles.formRow}>
              <div className={styles.formGroup}>
                <Controller
                  name="verifierPosition"
                  control={control}
                  render={({ field }) => (
                    <TextField
                      {...field}
                      label="ÏßÅÏúÑÍ≤ÄÏ¶ùÏûê"
                      fullWidth
                      disabled={isReadonly}
                    />
                  )}
                />
              </div>
            </div>
          </div>

          {/* üìã Section 4: Ï±ÖÎ¨¥Ï†ïÎ≥¥ (ÏÉÅÏÑ∏ Î™®ÎìúÏóêÏÑúÎßå ÌëúÏãú) */}
          {mode === 'view' && (
            <>
              <Divider className={styles.divider} />
              <div className={styles.formSection}>
                <Typography variant="h6" className={styles.sectionTitle}>
                  <AssignmentIcon />
                  Ï±ÖÎ¨¥Ï†ïÎ≥¥
                </Typography>

                <div className={styles.formRow}>
                  <div className={styles.formGroup}>
                    <Controller
                      name="responsibilityOverview"
                      control={control}
                      render={({ field }) => (
                        <TextField
                          {...field}
                          label="Ï±ÖÎ¨¥Í∞úÏöî"
                          multiline
                          rows={3}
                          fullWidth
                          disabled={isReadonly}
                        />
                      )}
                    />
                  </div>
                </div>

                <div className={styles.tableContainer}>
                  <BaseDataGrid
                    data={responsibilityFields}
                    columns={responsibilityColumns}
                    height={200}
                    pagination={false}
                    theme="alpine"
                  />
                </div>
              </div>

              <Divider className={styles.divider} />

              {/* üìã Section 5: Í¥ÄÎ¶¨ÏùòÎ¨¥ */}
              <div className={styles.formSection}>
                <Typography variant="h6" className={styles.sectionTitle}>
                  <GavelIcon />
                  Í¥ÄÎ¶¨ÏùòÎ¨¥
                </Typography>

                <div className={styles.tableContainer}>
                  <BaseDataGrid
                    data={obligationFields}
                    columns={managementObligationColumns}
                    height={200}
                    pagination={false}
                    theme="alpine"
                  />
                </div>
              </div>
            </>
          )}
        </form>
      </DialogContent>

      <DialogActions className={styles.modalActions}>
        <Button
          variant="outlined"
          onClick={onClose}
          disabled={loading}
        >
          Îã´Í∏∞
        </Button>
        {!isReadonly && (
          <Button
            variant="contained"
            onClick={handleSubmit(handleFormSubmit)}
            loading={loading}
            disabled={!isValid}
          >
            {modalConfig.submitLabel}
          </Button>
        )}
      </DialogActions>
    </Dialog>
  );
};

export default OfficerInfoFormModal;