# RSMS Backend Application Configuration
# Spring Boot 3.3.5 + Java 21 - 공통 설정

# Server Configuration
server:
  port: 8090
  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true
    session:
      cookie:
        name: SESSIONID
        http-only: true
        secure: false
        same-site: lax
        path: /
        max-age: 600  # 10분 (초 단위)
  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: on_param  # 스택트레이스는 ?trace=true 파라미터가 있을 때만 출력
  shutdown: graceful

# Spring Configuration - 공통 설정
spring:
  application:
    name: RSMS-Backend
    
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:local}
    
  main:
    banner-mode: console
    
  # Flyway Configuration - 공통 (Database Migration)
  flyway:
    enabled: true  # Flyway 활성화
    baseline-on-migrate: true  # 기존 스키마가 있을 경우 베이스라인 생성
    baseline-version: 0  # 베이스라인 버전
    locations: classpath:db/migration  # 마이그레이션 스크립트 위치
    validate-on-migrate: true  # 마이그레이션 검증
    out-of-order: false  # 순서 외 마이그레이션 금지

  # JPA Configuration - 공통
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    show-sql: true  # SQL 콘솔 출력
    hibernate:
      ddl-auto: validate  # Flyway로 스키마 관리
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
    properties:
      hibernate:
        format_sql: true  # SQL 포맷팅
        use_sql_comments: true  # SQL에 주석 추가
        default_batch_fetch_size: 16
        jdbc:
          batch_size: 20
          batch_versioned_data: true
        order_inserts: true
        order_updates: true
    open-in-view: false
    
  # Session Configuration - 공통 (Database-based, Redis 추후 전환 가능)
  session:
    store-type: jdbc
    jdbc:
      initialize-schema: never  # Flyway로 관리
      table-name: spring_session  # 소문자 테이블명 (스키마는 search_path로 해결)
      cleanup-cron: "0 */10 * * * *"  # 10분마다 정리
    timeout: 10m  # 세션 타임아웃 10분
    
  # Cache Configuration - 공통 (Ehcache → Redis 전환 가능)
  cache:
    type: jcache
    jcache:
      config: classpath:ehcache.xml
      
  # Jackson Configuration - 공통
  jackson:
    default-property-inclusion: non_null
    serialization:
      write-dates-as-timestamps: false
      fail-on-empty-beans: false
    deserialization:
      fail-on-unknown-properties: false
    time-zone: Asia/Seoul
    
# Management (Actuator) - 공통 설정
management:
  endpoints:
    web:
      base-path: /actuator
  endpoint:
    health:
      probes:
        enabled: true
  health:
    db:
      enabled: true
    diskspace:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}
      
# SpringDoc OpenAPI Configuration
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: alpha
  show-actuator: false
  
# Logging Configuration
logging:
  level:
    root: INFO
    com.rsms: DEBUG                                    # RSMS 전체 DEBUG 레벨
    com.rsms.domain.system.code: DEBUG                 # 코드관리 상세 로그
    org.springframework.web: DEBUG                     # Spring Web 요청/응답 로그
    org.springframework.web.servlet.mvc.method.annotation: TRACE  # 컨트롤러 메서드 호출 로그
    org.springframework.security: DEBUG                # Security 로그
    org.springframework.transaction: DEBUG             # 트랜잭션 로그 추가
    org.springframework.data.jpa: DEBUG                # JPA Repository 로그 추가
    org.hibernate.SQL: DEBUG                           # SQL 쿼리 출력
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE  # SQL 파라미터 바인딩 출력
    org.hibernate.orm.jdbc.bind: TRACE                 # JDBC 바인딩 상세 로그
    org.hibernate.engine.transaction: DEBUG            # 트랜잭션 엔진 로그 추가
    org.springframework.jdbc.core: DEBUG               # JDBC 실행 로그
    org.springframework.orm.jpa: DEBUG                 # JPA ORM 로그 추가
  pattern:
    console: "%d{HH:mm:ss.SSS} %highlight(%-5level) %cyan(%logger{20}) - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg%n"
  exception-conversion-word: "%ex{short}"  # 스택트레이스를 간단하게 출력

# RSMS 애플리케이션 공통 속성
rsms:
  security:
    jwt:
      secret: ${JWT_SECRET:rsms-secret-key-change-in-production}
      expiration: 86400000  # 24시간 (밀리초)
  upload:
    path: ${UPLOAD_PATH:./uploads}  # 파일 업로드 기본 경로
  cors:
    allowed-methods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
      - OPTIONS
    allowed-headers:
      - "*"
    allow-credentials: true
  file:
    max-size: 10MB
    allowed-extensions:
      - jpg
      - jpeg
      - png
      - gif
      - pdf
      - doc
      - docx
      - xls
      - xlsx