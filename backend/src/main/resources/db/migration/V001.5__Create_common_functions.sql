-- =====================================================================================
-- V101: 공통 함수 생성 (Common Functions)
-- =====================================================================================
-- 설명:
--   - RSMS 프로젝트에서 사용하는 공통 함수 정의
--   - update_updated_at_column(): UPDATE 시 updated_at 자동 갱신 함수
-- 작성일: 2025-10-28
-- Flyway 마이그레이션: V101
-- 참조: database/scripts/00.create_common_functions.sql
-- =====================================================================================

-- =====================================================================================
-- update_updated_at_column() 함수
-- =====================================================================================
-- 설명:
--   - 트리거에서 사용되는 공통 함수
--   - UPDATE 발생 시 updated_at 컬럼을 자동으로 현재 시각으로 갱신
--   - 모든 테이블의 updated_at 자동 갱신 트리거에서 재사용 가능
-- =====================================================================================

-- 기존 함수가 있으면 삭제
DROP FUNCTION IF EXISTS rsms.update_updated_at_column() CASCADE;

-- 공통 updated_at 갱신 함수 생성
CREATE OR REPLACE FUNCTION rsms.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  -- UPDATE 시 updated_at 컬럼을 현재 시각으로 자동 설정
  NEW.updated_at = CURRENT_TIMESTAMP;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 함수 설명
COMMENT ON FUNCTION rsms.update_updated_at_column() IS 'UPDATE 시 updated_at 컬럼을 자동으로 현재 시각으로 갱신하는 공통 트리거 함수';

-- =====================================================================================
-- 사용 예시
-- =====================================================================================
-- 테이블 생성 후 트리거 생성 시:
--
-- CREATE TRIGGER trigger_테이블명_updated_at
--   BEFORE UPDATE ON rsms.테이블명
--   FOR EACH ROW
--   EXECUTE FUNCTION rsms.update_updated_at_column();
-- =====================================================================================

-- =====================================================================================
-- 스크립트 완료
-- =====================================================================================
